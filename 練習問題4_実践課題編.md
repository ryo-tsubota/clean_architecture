# 練習問題4: 実践課題編

## 大課題1: ECサイトの商品管理システム

クリーンアーキテクチャを使って、ECサイトの商品管理システムを構築してください。

### 要件

**機能要件:**
- 商品の登録・更新・削除・検索
- カテゴリ管理
- 在庫管理
- 価格変更履歴の管理
- 商品レビューの管理

**非機能要件:**
- FastAPIを使用
- PostgreSQLでデータ永続化
- Redisでキャッシュ
- ログ出力
- エラーハンドリング
- テスト可能な設計

**ビジネスルール:**
- 商品価格は0円以上
- 在庫数は負にならない
- 削除された商品は論理削除
- レビューは購入済みユーザーのみ可能
- 価格変更は履歴として保存

### 課題

**Phase 1: ドメインモデルの設計**
1. `Product`, `Category`, `Review`, `PriceHistory`エンティティを設計
2. 値オブジェクト（Price, Stock, Rating等）を設計
3. ドメインサービスがあれば設計

**Phase 2: アプリケーション層の設計**
1. 必要なリポジトリインターフェースを定義
2. ユースケースクラスを設計（商品作成、更新、検索等）
3. DTOを設計

**Phase 3: インフラ層の実装**
1. SQLAlchemyモデルを作成
2. リポジトリの実装
3. FastAPIコントローラーの実装

**Phase 4: 統合とテスト**
1. DIコンテナの設定
2. エラーハンドリングの実装
3. ユニットテストの作成

### 実装ガイド

```python
# ヒント: 開始コード構造

# domain/entities.py
@dataclass
class Product:
    id: str
    name: str
    description: str
    price: Price
    category_id: str
    stock: Stock
    is_deleted: bool = False
    created_at: datetime = field(default_factory=datetime.now)
    
    def update_price(self, new_price: Price) -> 'PriceHistory':
        # TODO: 価格変更ロジック
        pass

# application/use_cases.py  
class ProductUseCases:
    def __init__(
        self,
        product_repo: IProductRepository,
        category_repo: ICategoryRepository,
        price_history_repo: IPriceHistoryRepository
    ):
        # TODO: 実装
        pass
    
    def create_product(self, dto: CreateProductDTO) -> ProductDTO:
        # TODO: 実装
        pass
```

## 大課題2: ブログシステム

多機能なブログシステムを構築してください。

### 要件

**機能要件:**
- ユーザー登録・認証
- 記事の作成・編集・公開・削除
- コメント機能
- タグ機能
- いいね機能
- 記事の検索・フィルタリング

**技術要件:**
- JWT認証
- 全文検索（Elasticsearch想定）
- 画像アップロード
- メール通知
- API仕様書の自動生成

**ビジネスルール:**
- 記事は下書き・公開・非公開状態を持つ
- コメントは承認制
- タグは事前定義されたもののみ使用可能
- いいねの取り消し可能

### 課題

各機能を段階的に実装し、クリーンアーキテクチャの原則を守りながら拡張してください。

## 大課題3: タスク管理システム

チーム向けのタスク管理システムを構築してください。

### 要件

**機能要件:**
- プロジェクト管理
- タスク管理（作成、割り当て、ステータス変更）
- チーム管理
- 権限管理
- 通知機能
- レポート機能

**技術的チャレンジ:**
- WebSocket使用のリアルタイム更新
- 複雑な権限制御
- バッチ処理（レポート生成）
- 外部カレンダー連携

### 特別課題: アーキテクチャ進化

1. **マイクロサービス化**: 単一のモノリスから複数のマイクロサービスに分割
2. **CQRS実装**: 読み取りと書き込みを分離
3. **イベントソーシング**: イベント履歴からの状態再構築

## 小課題集

### 課題A: エラーハンドリング統合

以下のエラーケースを適切にハンドリングするシステムを設計してください。

```python
# シナリオ
class OrderService:
    def place_order(self, dto: PlaceOrderDTO) -> OrderDTO:
        # 1. 在庫不足
        # 2. 決済失敗  
        # 3. 配送先不正
        # 4. 顧客情報不正
        # 5. システムエラー
        pass
```

**要求:**
- 各エラーに適切な例外クラス
- HTTPステータスコードへのマッピング
- ログ出力とモニタリング
- ユーザー向けエラーメッセージ

### 課題B: パフォーマンス最適化

大量データを効率的に処理するシステムを実装してください。

**シナリオ:** 100万件の商品データを持つECサイト

**要求:**
- ページネーション
- キャッシュ戦略
- N+1問題の回避
- インデックス戦略
- 非同期処理

### 課題C: 複雑なビジネスルール

以下のビジネスルールを実装してください。

**割引システム:**
- 顧客ランクによる割引
- 購入金額による段階割引
- 期間限定セール
- クーポン適用
- 複数割引の組み合わせルール

**在庫引当システム:**
- 複数倉庫からの引当
- 優先順位付き引当
- 仮引当と確定引当
- キャンセル時の在庫戻し

## 評価ポイント

### 必須要件
- [ ] 依存性のルールが守られている
- [ ] 各レイヤーの責務が明確
- [ ] テスト可能な設計
- [ ] 型安全性
- [ ] エラーハンドリング

### 加点ポイント
- [ ] 設計パターンの適切な使用
- [ ] パフォーマンス考慮
- [ ] セキュリティ考慮
- [ ] ドキュメント品質
- [ ] 運用考慮（ログ、モニタリング）

### 発展課題
- [ ] マイクロサービス分割戦略
- [ ] 非同期処理とイベント駆動
- [ ] CQRS/イベントソーシング
- [ ] 分散トランザクション
- [ ] 複数データベース対応

## 提出フォーマット

```
project_name/
├── README.md              # 設計方針とアーキテクチャ説明
├── docs/
│   ├── architecture.md    # アーキテクチャドキュメント
│   ├── api_spec.md       # API仕様
│   └── deployment.md     # デプロイ手順
├── src/
│   ├── domain/           # ドメイン層
│   ├── application/      # アプリケーション層  
│   ├── infrastructure/   # インフラ層
│   └── main.py          # エントリーポイント
├── tests/               # テストコード
├── docker-compose.yml   # 開発環境
└── requirements.txt     # 依存関係
```

## レビュー観点

### コード品質
1. **クリーンアーキテクチャ原則の遵守**
2. **SOLID原則の適用**
3. **型安全性とmypy対応**
4. **テストカバレッジ**
5. **ドキュメント品質**

### 実装品質
1. **エラーハンドリングの網羅性**
2. **パフォーマンス考慮**
3. **セキュリティ対応**
4. **運用考慮**
5. **拡張性と保守性**

### 設計判断
1. **レイヤー分割の妥当性**
2. **パターン選択の理由**
3. **トレードオフの考慮**
4. **将来性への配慮**
5. **チーム開発への配慮**