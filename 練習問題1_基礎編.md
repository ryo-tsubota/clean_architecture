# 練習問題1: クリーンアーキテクチャの基礎

## 問題1-1: 依存性のルールの理解

次の説明文を読んで、クリーンアーキテクチャの依存性のルールに違反している箇所を特定してください。

**シナリオ:**
「ToDoアプリケーションで、エンティティ層の`TodoItem`クラスの中で、直接SQLAlchemyのモデルを呼び出してデータベースにアクセスしている。また、ユースケース層の`TodoUseCases`クラスから、FastAPIの`HTTPException`を直接importして使用している。」

**問題:**
1. どの部分が依存性のルールに違反していますか？
2. なぜこれが問題なのか説明してください。
3. どのように修正すべきか提案してください。

## 問題1-2: レイヤーの識別

以下のコンポーネントを、クリーンアーキテクチャの4つのレイヤー（Entities、Use Cases、Interface Adapters、Frameworks & Drivers）に分類してください。

**コンポーネント一覧:**
- `FastAPIのルーター`
- `TodoItemエンティティ`
- `SQLAlchemyのORMモデル`
- `TodoRepositoryインターフェース`
- `TodoUseCasesクラス`
- `SQLAlchemyRepositoryの実装`
- `FastAPIコントローラー`
- `CreateTodoDTO`
- `PostgreSQLデータベース`
- `ビジネスルール（例：タスクの重複チェック）`

## 問題1-3: 関心の分離

次のコードは関心の分離ができていません。問題点を指摘し、改善案を提示してください。

```python
class TodoService:
    def __init__(self):
        # データベース接続を直接作成
        self.engine = create_engine("postgresql://user:pass@localhost/db")
        self.session = sessionmaker(bind=self.engine)()
    
    def create_todo(self, title: str) -> dict:
        # バリデーション
        if not title or len(title) < 3:
            return {"error": "タイトルは3文字以上で入力してください", "status": 400}
        
        # ビジネスロジック
        todo_id = str(uuid.uuid4())
        
        # データベース操作
        todo = TodoModel(id=todo_id, title=title, completed=False)
        self.session.add(todo)
        self.session.commit()
        
        # レスポンス生成
        return {
            "id": todo_id,
            "title": title,
            "completed": False,
            "status": 201
        }
```

## 問題1-4: 独立性の理解

以下の質問に答えてください。

1. クリーンアーキテクチャで「独立性」が重要な理由を3つ挙げてください。
2. 「UIから独立している」とはどういう意味ですか？具体例を交えて説明してください。
3. 「データベースから独立している」とはどういう意味ですか？具体例を交えて説明してください。
4. 「フレームワークから独立している」とはどういう意味ですか？具体例を交えて説明してください。

## 問題1-5: 同心円モデルの説明

あなたがクリーンアーキテクチャを知らない同僚に説明するとして、同心円モデルについて簡潔に説明してください。以下の点を含めてください。

1. 4つのレイヤーそれぞれの役割
2. 依存性のルールとその意味
3. なぜこの構造が有効なのか

---

## 解答例

### 問題1-1の解答例

**違反箇所:**
1. エンティティ層でSQLAlchemyを直接使用している
2. ユースケース層でFastAPIの例外を直接使用している

**問題点:**
1. エンティティはフレームワークから独立すべきだが、SQLAlchemyに依存している
2. ユースケースはWebフレームワークから独立すべきだが、FastAPIに依存している

**修正案:**
1. エンティティからデータベースアクセスを削除し、純粋なビジネスロジックのみにする
2. ユースケースでは独自の例外クラスを定義し、コントローラー層で適切なHTTP例外に変換する

### 問題1-2の解答例

- **Entities**: TodoItemエンティティ、ビジネスルール
- **Use Cases**: TodoUseCasesクラス、CreateTodoDTO
- **Interface Adapters**: TodoRepositoryインターフェース、SQLAlchemyRepositoryの実装、FastAPIコントローラー
- **Frameworks & Drivers**: FastAPIのルーター、SQLAlchemyのORMモデル、PostgreSQLデータベース

### 問題1-3の解答例

**問題点:**
- ビジネスロジック、データアクセス、バリデーション、レスポンス生成が混在
- データベースに直接依存している
- テストが困難

**改善案:**
- エンティティ、ユースケース、リポジトリ、コントローラーに分離
- 依存性注入を使用してデータベースへの依存を抽象化
- バリデーションはDTO、レスポンス生成はコントローラーで処理